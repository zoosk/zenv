#! /usr/bin/env bash

# Usage information
if [ "$1" == '-h' -o "$1" == '--help' ]; then
    PROGNAME=$(basename $0)
    echo "${PROGNAME}: force your dev instance to be updated to the specified cf engine branch"
    echo "Usage: ${PROGNAME} branch"
    exit 1
fi

# Startup checks
if [ -z "$ZENV_INITIALIZED" ]; then
    echo 'You must run this program from within ZEnv.'
    exit 1
elif [ -z "$ZENV_CURRENT_WORK" ]; then
    echo "you must use a workspace before proceeding"
    exit 1
fi

if [ "$1" == '' ]; then
    echo "you must specify a branch of Ops / cfengine in the command line"
    exit 1
fi
BRANCH=$1
RETURN_DIRECTORY=`pwd`
TN=`date +%Y%m%d%H%M`
TD=git${TN}
cd /tmp
mkdir $TD
cd $TD
git clone git@g.zoosk.com:Ops/cfengine.git
cd cfengine
git checkout $BRANCH
tar -cf ../cfe.tar 40_applications 50_settings promises.cf
cd ..
echo "Forcing a reload of configuration on your dev instance."
URL="http://sfo2-dev-vmdev${ZENV_DEVID_PADDED}.sfo2.zoosk.com:5555/zenv/cfengine"
curl --connect-timeout 120 --max-time 180 -F tarfile=@cfe.tar $URL
cd ..
rm -Rf $TD
cd $RETURN_DIRECTORY
