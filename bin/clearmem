#! /usr/bin/env bash

# Usage information
if [ "$1" == '-h' -o "$1" == '--help' ]; then
    PROGNAME=$(basename $0)
    echo "${PROGNAME}: Clear memcached on your dev instance."
    echo "Usage: ${PROGNAME} [cache_name] [cache_name] ..."
    echo "Where cache_name can be one or more of: mem cookie search zsms wurfl"
    echo "Passing nothing will clear everything."
    exit 1
fi

# Startup checks
if [ -z "$ZENV_INITIALIZED" ]; then
    echo 'You must run this program from within ZEnv.'
    exit 1
elif [ -z "$ZENV_CURRENT_WORK" ]; then
    echoerr 'You must set a workspace before clearing its memcached.'
    exit 1
fi


if [ "$1" == '' ]; then
    CMD="php ${ZENV_SERVERDIR}/web/test/data/memcached_flush.php 2>/dev/null"
else
    ARGS=$*
    CMD=""
    pre="sudo /etc/init.d/memcached-"
    post=" restart; sleep 2;"
    echo "Legend ([mem]=11212 [cookie]=11213 [search]=11214 [zsms]=11215 [wurfl]=11216)"
    for P in $ARGS; do
        if [ $P == "mem" ]; then
            CMD="$CMD ${pre}11212${post}"
        fi
        if [ $P == "cookie" ]; then
            CMD="$CMD ${pre}11213${post}"
        fi
        if [ $P == "search" ]; then
            CMD="$CMD ${pre}11214${post}"
        fi
        if [ $P == "zsms" ]; then
            CMD="$CMD ${pre}11215${post}"
        fi
        if [ $P == "wurfl" ]; then
            CMD="$CMD ${pre}11216${post}"
        fi
    done
fi

ssh -t "$ZENV_DEVSERVER" "$CMD"
