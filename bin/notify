#!/bin/sh

# Cross-platform OSX / Linux notification utility

# bail on errors
set -e

# bail on undefined values
# set -u

# Startup checks
if [ -z "$ZENV_INITIALIZED" ]; then
    echo 'You must run this program from within ZEnv.'
    exit 1
fi
i=0;
NTITLE=''; # Title
NMSG='';   # Message
NWAIT=2;   # Residency time

# Set title and message per options
while :; do
  case $1 in
    -h|--help|-\?)
      echo "One day, this will be helpful."
      exit
      ;;

    -t|-title|--title)
      if [ "${2}" ]; then
        NTITLE="${2}"
        shift 2
        continue
      else
        echo "Error, option ${1} requires an argument."
        exit 1
      fi
      ;;

    -m|-message|--message)
      if [ "${2}" ]; then
        NMSG="${2}"
        shift 2
        continue
      else
        echo "Error, option ${2} requires an argument."
        exit 1
      fi
      ;;

    -w|-wait|--wait)
      if [ "${2}" ]; then
        let NWAIT="${2}"+0
        shift 2
        continue
      else
        echo "Error, option ${2} requires an argument."
        exit 1
      fi
      ;;

    --) # end of all options
      shift
      break
      ;;

    *)
      # If no options provided, use the first argument as the message
      if [ -z "${NTITLE}" ] && [ -z "${NMSG}" ]; then
        NTITLE="${1}"
        NMSG=""
        if [ -z "${NTITLE}" ]; then exit 0; fi
      fi
      break
      ;;
  esac
  shift
done


# This environment variable should be set for all Linux distros
# and will provide 'KDE', 'UNITY', 'GNOME', etc
NOTIFY_DE="${XDG_CURRENT_DESKTOP}"

# Blank variables make some utilities cranky....
if ( echo "${NTITLE}" |grep -q '^\s*$' ); then
  NTITLE="--";
fi

if ( echo "${NMSG}" |grep -q '^\s*$' ); then
  NMSG="--";
fi


case "${NOTIFY_DE}" in
  '') # OSX
    BIN_FILE="${ZENV_ROOT}/utils/terminal-notifier.app/Contents/MacOS/terminal-notifier"
    if [ ! -z "${BIN_FILE}" ]; then
      $BIN_FILE -title "${NTITLE}" -message "${NMSG}"
    fi
    ;;
  KDE) # KDE, of course
    if [ ! -z $(which kdialog) ]; then
      echo kdialog --title "\"${NTITLE}\" --passivepopup \"${NMSG}\" \"${NWAIT}\""
      kdialog --title "${NTITLE}" --passivepopup "${NMSG}" "${NWAIT}"
    fi
    ;;
  *) # Unity, Gnome, etc
    if [ ! -z $(which notify-send) ]; then
      notify_send "${NTITLE}" "${NMSG}" -t "${NWAIT}"
    fi
    ;;
esac
