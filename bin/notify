#! /usr/bin/env bash

## Bail on errors or unset vars
set -e # we can not use set -u as we rely on XDG_CURRENT_DESKTOP

# Startup checks
if [ -z "$ZENV_INITIALIZED" ]; then
    echo 'You must run this program from within ZEnv.'
    exit 1
fi

NOTIFY_DE="${XDG_CURRENT_DESKTOP}"

# Support OSX EXACTLY as before
if [ -z "${NOTIFY_DE}" ]; then
    BIN_FILE="${ZENV_ROOT}"/utils/terminal-notifier.app/Contents/MacOS/terminal-notifier
    if [ -n "$1" -a "$(echo "$1" | sed 's/\(.\).*/\1/')" != '-' ]; then
        $BIN_FILE -message "$1"
    else
        $BIN_FILE "$@"
    fi
    exit $?
fi

# Other environments
NOTIFY_TITLE=''; # Title
NOTIFY_MSG='';   # Message
NOTIFY_DWELL=2;  # Residency time
ARG_STACK=();

# Set title and message per options
while :; do
  case $1 in
    -h|--help|-\?)
      echo "Notify is a zenv cross-platform wrapper for desktop notifications."
      echo "Only -message and -title options are supported across all platforms."
      exit 0;
      ;;

    -title)
      if [ "${2}" ]; then
        NOTIFY_TITLE="${2}"
        shift 2
        continue
      else
        echo "Error, option ${1} requires an argument."
        exit 1
      fi
      ;;

    -message)
      if [ "${2}" ]; then
        NOTIFY_MSG="${2}"
        shift 2
        continue
      else
        echo "Error, option ${2} requires an argument."
        exit 1
      fi
      ;;

    -dwell)
      if [ "${2}" ]; then
        let NOTIFY_DWELL="${2}"+0
        shift 2
        continue
      else
        echo "Error, option ${2} requires an argument."
        exit 1
      fi
      ;;

    --) # end of all options
      shift
      break
      ;;

    *)
      # If no options provided, use the first argument as the message
      # and the second as the title.
      if [ -z "${NOTIFY_MSG}" ] && [ -z "${NOTIFY_TITLE}" ]; then
        NOTIFY_MSG="${1}"
        if [ -z "${NOTIFY_MSG}" ]; then exit 0; fi
      fi
      break
      ;;
  esac
  shift
done


case "${NOTIFY_DE}" in
    KDE)
        if [ ! -z $(which kdialog) ]; then
            ARG_STACK+=('--title')
            ARG_STACK+=("${NOTIFY_TITLE:-...}")
            ARG_STACK+=('--passivepopup')
            ARG_STACK+=("${NOTIFY_MSG:-...}")
            ARG_STACK+=("${NOTIFY_DWELL}")

            kdialog ${ARG_STACK[*]}
        fi
        ;;
    *) # Unity, Gnome, etc
        if [ ! -z $(which notify-send) ]; then
            ARG_STACK+=("${NOTIFY_TITLE:-...}")
            ARG_STACK+=("${NOTIFY_MSG:-...}")
            ARG_STACK+=('-t')
            ARG_STACK+=("${NOTIFY_DWELL}")

            notify_send ${ARG_STACK[*]}
        fi
        ;;
esac
