#! /usr/bin/env bash

function usage() {
	PROGNAME=$(basename $0)
	echo ""
	echo "===== ZHOST ====="
	echo "Easy to use host manipulation system."
	echo "You can easily manpulates your /etc/hosts file with this program."
	echo ""
	echo "AVAILABLE COMMANDS"
	echo "------------------"
	echo "zhost add <hostname> <ip>"
	echo "zhost delete <hostname>"
	echo "zhost show"
	echo "zhost clear"
	return
}

function add() {
    if [ "$1" = "" -o "$2" = "" ];then
        usage
        return
    fi
	# when the given ip exists in /etc/hosts
	if grep -q "$2" /etc/hosts ; then
	    sudo sed -i -e "s/$2.*/$2 $1 # added by ZEnv zhost/" /etc/hosts && echo "Successfully modified an entry in zhost."
	    return
	fi

	# when the given hostname exists in /etc/hosts
	if grep -q "$1" /etc/hosts ; then
	    sudo sed -i -e "s/.*$1.*/$2 $1 # added by ZEnv zhost/" /etc/hosts && echo "Successfully modified an entry in zhost."
	    return
	fi

	# add as a new entry
	echo "$2 $1 # added by ZEnv zhost" | sudo tee -a /etc/hosts >> /dev/null
	[ "$?" = 0 ] && echo "Successfully added an entry to zhost."
}

function delete() {
    if [ "$1" = "" ]; then
        usage
        return
    fi

    read -p "Are you sure you want to delete $1 from zhost? [y/n] (n)" ANSWER
    if [ "$ANSWER"  = "y" ]; then
        sudo sed -i -e "/$1 # added by ZEnv zhost/d" /etc/hosts && echo "Successfully deleted $2from zhost."
        return
    fi
    echo "Aborting..."
}


function clear() {
    read -p "Are you sure you want to delete all zhost entries from zhost? [y/n] (n)" ANSWER
    if [ "$ANSWER" = "y" ]; then
        sudo sed -i -e "/added by ZEnv zhost/d" /etc/hosts && echo "Successfully cleared zhost entries."
        return
    fi
    echo "Aborting..."

}

function show() {
    echo "List of zhost entries"
    while read -r line; do
        [[ "$line" =~ "added by ZEnv zhost" ]] && echo - $line
    done < /etc/hosts
}

echo "You might be prompted with your local machine password."
echo "-------------------------------------------------------"

case "$1" in
	"add" )
	    add $2 $3
	    ;;
	"delete" )
	    delete $2
	    ;;
	"clear" )
	    clear
	    ;;
	"show" )
	    show
	    ;;
	* )
	    usage
	    ;;
esac