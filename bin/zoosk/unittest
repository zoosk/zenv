#! /usr/bin/env bash 
if [ "$1" == '-h' -o "$1" == '--help' -o "$1" == '' ]; then
    PROGNAME=$(basename $0)
    echo "${PROGNAME}: Runs unit test under web/test folder on your dev instance."
    echo "Usage: ${PROGNAME} unit_test_name [optional_unit_test_function .. when provided will execute only that specific test]"
    echo "Example1: unittest CoinTest.php"
    echo "Example2: unittest CoinTest.php testInvalidateCoinLog"
    exit 1
fi

if [ -z "$ZENV_INITIALIZED" ]; then
    echo "You must run this program from within ZEnv."
    exit 1
elif [ -z "$ZENV_CURRENT_WORK" ]; then
    echo 'You must use a checkout before you can run its scripts.'
    exit 1
fi


SCRIPT_NAME="$1"
SCRIPT_ARG="$2" 

if [[ $SCRIPT_NAME == *.php ]]; then
  SCRIPT_NAME=${SCRIPT_NAME:0:${#SCRIPT_NAME}-4}
fi

WEB_TEST=${ZENV_SERVERDIR}/web/test
files=( $(find ${WEB_TEST}/api ${WEB_TEST}/data ${WEB_TEST}/includes ${WEB_TEST}/suites -type f -iname ${SCRIPT_NAME}*.php) )
num_results=${#files[@]}

if [ $num_results -eq 0 ]
then 
   echo "No Unit test with name $1 exists"
elif [ $num_results -gt 1 ]
then
   echo "More that 1 unit test exist with the file name $1"
else
   UNIT_TEST_PATH=${files[0]}
   if [ -n "$2" ]
   then 
	ssh "$ZENV_LDAP_USERNAME"@"$ZENV_DEVSERVER" "if [ -e ~/.bashrc ]; then source ~/.bashrc; fi && if [ -e ~/.bash_profile ]; then source ~/.bash_profile; fi && phpunit --filter $2 $UNIT_TEST_PATH" 
   else
	ssh "$ZENV_LDAP_USERNAME"@"$ZENV_DEVSERVER" "if [ -e ~/.bashrc ]; then source ~/.bashrc; fi && if [ -e ~/.bash_profile ]; then source ~/.bash_profile; fi && phpunit $UNIT_TEST_PATH"
   fi 	
fi

