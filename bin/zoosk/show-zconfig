#! /usr/bin/env python

import json
import webbrowser
import datetime
import time
import os
import sys
import re

from subprocess import call
from zenvlib import environ, cli


cli.check_usage(
    '%P: Shows Zoosk configuration set for your environment'
)

cli.fail_without_workspace()

work_dir = environ.current_work
os.chdir(work_dir)
devserver = environ.devserver

call(['scp', devserver+':/srv/zoosk/current/config/ZConfig.php', '.'])
file_path = work_dir + '/ZConfig.php'

pattern = re.compile(r'\s*const\s*\w+\s*=+\s*\'\w*\';')



display_filename = `int(time.mktime(datetime.datetime.now().timetuple()))`+'.html'
display_file = open(display_filename, 'w')
display_file.write('<html><head>')
display_file.write('<style>th td{font-size: large;}')
display_file.write('a.tooltip {outline:none;}')
display_file.write('a.tooltip strong {line-height:30px;}')
display_file.write('a.tooltip:hover {text-decoration:none;}')
display_file.write('a.tooltip span {')
display_file.write('    z-index:10;display:none; padding:14px 20px;')
display_file.write('    margin-top:60px; margin-left:-160px;')
display_file.write('    width:300px; line-height:16px;')
display_file.write('}')
display_file.write('a.tooltip:hover span{')
display_file.write('    display:inline; position:absolute;')
display_file.write('    border:2px solid #FFF; color:#EEE;')
display_file.write('    background:#333 repeat-x 0 0;')
display_file.write('}')
display_file.write('.callout {z-index:20;position:absolute;border:0;top:-14px;left:120px;}')
display_file.write('a.tooltip span')
display_file.write('{')
display_file.write('    border-radius:2px;')
display_file.write('    box-shadow: 0px 0px 8px 4px #666;')
display_file.write('}')
display_file.write('</style>')
display_file.write('<title>Z Config</title></head><body>')
display_file.write('<table border="1"><tr><th>ZConfig</th><th>Value</th></tr>')

with open(file_path) as f:
    for line in f:
        if pattern.search(line):
            words = line.strip().split()
            display_file.write('<tr><td>' + words[1] + '</td><td style="text-align: right;">'+ words[3].split(";")[0] +'&nbsp;</td>')

display_file.write('</table>')
display_file.write('</body></html>')
display_file.close()

webbrowser.open_new('file://'+work_dir+'/'+display_filename)

time.sleep(2)
os.remove(display_filename)
os.remove(file_path)