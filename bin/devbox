#! /usr/bin/env bash

function exitWithError() {
    # Usage: exitWithError "Your error message."
    echo "${0##*/}: $@" >&2
    exit 1
}

function exitWithHelp() {
    # Usage statement
    PROGNAME="${0##*/}"
    cat <<- EOF >&2
${PROGNAME}: SSH to any Zoosk VM.
${BOLD}Usage: ${TXTRESET}${PROGNAME} <devID>${TXTRESET}
Where <devID> is the non-padded number of the VM you want to ssh to (ex: '74').
Not providing an argument will default to your personal VM.
Use -l or --list to open a list of Zoosk VMs.
EOF
    exit 0
}

function exitWithList() {
        # Opens the FogBugz wiki with a list of VMs numbers and their owners.
        if [ -n "$(which open)" ]; then
            open 'https://f.corp.zoosk.com/default.asp?W550'
            exit "$?"
        elif [ -n "$(which xdg-open)" ]; then
            xdg-open 'https://f.corp.zoosk.com/default.asp?W550'
            exit "$?"
        else
            echo 'https://f.corp.zoosk.com/default.asp?W550'
            exit "$?"
        fi
}

function main() {
        # Startup checks
        if [[ -z "${ZENV_INITIALIZED}" ]]; then
            exitWithError 'You must run this program from within ZEnv.'
        elif [[ -z "$ZENV_CURRENT_WORK" ]]; then
            exitWithError 'You must first set a workspace'
        fi

        case "$1" in
            -h|--help)
                exitWithHelp
            ;;
            -l|--list)
                exitWithList
            ;;
        esac

        # Ssh to personal VM if no argument is specified.
        if [[ -z "$1" ]]; then
            ssh "${ZENV_LDAP_USERNAME}@${ZENV_DEVSERVER}"
            exit "$?"
        fi

        # Regex pattern for bash compatibility.
        regex='^[0-9]+$'

        # If an argument is specified, check to make sure the argument is a number,
        # We then want to make sure it isn't more than 4 characters,
        # with the assumption that VMs are no more than 3 characters.
        if [[ "$1" =~ ${regex} ]]; then
            if [[ "${#1}" < 4 ]]; then
                ssh "${ZENV_LDAP_USERNAME}@www$(printf '%03d' $1).sfo2.zoosk.com"
                exit "$?"
            else
                exitWithError "Oops: A devID can't be more than 3 digits."
            fi
        else
            exitWithError "Oops, '$1' is not a valid dev number, please enter a number (eg. '74')."
        fi
}

main "$@"
