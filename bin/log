#! /usr/bin/env bash

# Usage information
if [ "$1" == '-h' -o "$1" == '--help' ]; then
    PROGNAME=$(basename $0)
    echo "${PROGNAME}: Tail today's apache log or the syslog on your dev instance."
    echo "Usage (list available logs): ${PROGNAME}"
    echo "Usage (tail the syslog): ${PROGNAME} syslog"
    echo "Usage (tail an apache log): ${PROGNAME} log_product_name [log_kind]"
    echo ''
    echo "Examples:"
    echo "Touch error log: ${PROGNAME} t"
    echo "Web access log: ${PROGNAME} www access"
    exit 1
fi

# Startup checks
if [ -z "$ZENV_INITIALIZED" ]; then
    echo 'You must run this program from within ZEnv.'
    exit 1
elif [ -z "$ZENV_CURRENT_WORK" ]; then
    echo 'You must set a workspace before looking at its logs.'
    exit 1
fi


# Create a command to run on the server based on the different arguments this program can take
if [ "$1" == '' ]; then
    # Just list the logs
    echo "${UNDERLINE}Last Update${TXTRESET}      ${UNDERLINE}Log Title${TXTRESET}"
    CMD="ls -lt /var/log/apache2 | grep dev${ZENV_DEVID} | head | awk '{print \$6, \$7, \$8}' | sed 's/_web4dev_dev30_/ /' | sed 's/\.log.*//'"
elif [ "$1" == 'syslog' ]; then
    # Tail syslog
    CMD="tail -f /var/log/syslog"
else
    # Tail an apache log, the 'error' one by default
    LOGNAME='error'
    if [ "$2" != "" ]; then
        LOGNAME="$2"
    fi
    CMD="tail -f /var/log/apache2/${1}_web4dev_dev${ZENV_DEVID}_${LOGNAME}.log_$(date '+%Y-%m-%d')"
fi
ssh "$ZENV_DEVSERVER" $CMD
