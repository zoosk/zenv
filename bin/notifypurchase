#! /usr/bin/env bash

# Usage information
if [ "$1" == '-h' -o "$1" == '--help' ]; then
    PROGNAME=$(basename $0)
    echo "${PROGNAME}: Generate a purchase notification for a given order."
    echo "Usage: ${PROGNAME} [order_id]"
    echo "If order_id is not specified, the most recent order will be used."
    exit 1
fi

# Startup checks
if [ -z "$ZENV_INITIALIZED" ]; then
    echo 'You must run this program from within ZEnv.'
    exit 1
elif [ -z "$ZENV_CURRENT_WORK" ]; then
    echoerr 'You must set a workspace before generating a notification.'
    exit 1
fi

if [ "$1" == '' ]; then
    PARTS=$(echo "select id, user_id from payment_orders order by id desc limit 1" |  mysql -h ${ZENV_DBIP} -u root -p$(readprop dev_rootdbpass) ${ZENV_DEVID}finance 2>/dev/null | tail -1)
    ORDER_ID=$(echo $PARTS | awk '{print $1}')
    USER_ID=$(echo $PARTS | awk '{print $2}')
    echo "No order specified, using the most recent order (order ${ORDER_ID} for user ${USER_ID})"
else
    ORDER_ID="$1"
    USER_ID=$(echo "select user_id from payment_orders where id=${ORDER_ID} limit 1" |  mysql -h ${ZENV_DBIP} -u root -p$(readprop dev_rootdbpass) ${ZENV_DEVID}finance 2>/dev/null | tail -1)
fi

ssh "$ZENV_LDAP_USERNAME"@"$ZENV_DEVSERVER" "php ${ZENV_SERVERDIR}/web/test/scripts/money/generate_purchase_notification.php -u ${USER_ID} -o ${ORDER_ID}" && clearmem
