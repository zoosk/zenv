#! /usr/bin/env bash

if [ "$1" == '-h' -o "$1" == '--help' ]; then
    PROGNAME=$(basename $0)
    echo "${PROGNAME}: Update your checkout of ZEnv to the latest version."
    exit 1
fi

if [ -z "$ZENV_INITIALIZED" ]; then
    echo "You must run this program from within ZEnv."
    exit 1
fi

UPDATE_TEXT=$(cd "${ZENV_ROOT}"; git pull; git submodule update)
cd $ZENV_ROOT/utils
if [ ! -d zli ]; then
   git clone git@g.zoosk.com:merrickp/zli.git
fi
cd zli
git pull

TOPLINE="${RED}${BOLD}OMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMGOMG${TXTRESET}"
BORDER="${RED}${BOLD}OMG${TXTRESET}"

if [ "$(echo "${UPDATE_TEXT}" | grep install.sh)" != '' ]; then
    sed -i '' "/### BEGIN ZENV INIT/,/### END ZENV INIT/d" ~/.bash_login
    sed -i '' '/^alias zenv/d' ~/.bash_login
    rm -f "$ZENV_SETTINGS"
    echo $TOPLINE
    echo "$BORDER The ZEnv install process has been updated!                          $BORDER"
    echo "$BORDER You will need to reinstall ZEnv for changes to take effect.         $BORDER"
    echo "$BORDER To do this, restart your terminal and then run:                     $BORDER"
    printf "$BORDER %-67s ${BORDER}\n" "cd ${ZENV_ROOT}; ./install.sh"
    echo $TOPLINE

elif [ "$(echo "${UPDATE_TEXT}" | grep 'functions/')" != '' ]; then
    echo $TOPLINE
    echo "$BORDER The ZEnv core has been updated!                                     $BORDER"
    echo "$BORDER You will need to restart your terminal for changes to take effect.  $BORDER"
    echo $TOPLINE
    
else
    echo "$UPDATE_TEXT"
fi
