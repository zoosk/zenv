#! /usr/bin/env bash

function usage() {
    PROGNAME=$(basename $0)
    echo ""
    echo "===== ${PROGNAME} ====="
    echo "${PROGNAME} is used to do database migration."
    echo ""
    echo "AVAILABLE COMMANDS"
    echo "------------------"
    echo "${PROGNAME} status"
    echo "${PROGNAME} install"
    echo "${PROGNAME} uninstall"
    echo "${PROGNAME} help"
    echo ""
    exit 1
}

# Usage information
if [ "$1" == '-h' -o "$1" == '--help' ]; then
    usage
fi

if [ -z "$ZENV_CURRENT_WORK" ]; then
    echo 'You must use a checkout before you can run the db tool.'
    exit 1
fi

PATH=${ZENV_LOCAL_DEPLOY_DIR}/dev${ZENV_DEVID}_build
toolpath=${PATH}/zs-db-tool
version="master-1"

function status() {
    if [ ! -d $toolpath ]
    then
        echo "${PROGNAME} is not installed."
        exit 1
    fi
    echo "${PROGNAME} is installed."
}

function install() {
    if [ -d $toolpath ]
    then
        echo "${PROGNAME} is installed."
        exit 1
    fi
    cd $PATH
    url="http://build1qa.sfo2.zoosk.com:8081/nexus/content/repositories/platform/com/zoosk/zs-db-tool/${version}/zs-db-tool-${version}.tgz"
    /usr/bin/curl -O $url
    /usr/bin/tar -xzf ${PATH}/zs-db-tool-${version}.tgz
    /usr/bin/php ${PATH}/zs-db-tool/composer.phar install -n
    /bin/rm ${PATH}/zs-db-tool-${version}.tgz
}

function uninstall() {
    if [ ! -d $toolpath ]
    then
        echo "${PROGNAME} is not installed."
        exit 1
    fi
    /bin/rm -rf ${toolpath}
}

case "$1" in
    "install" )
        install
        ;;
    "status" )
        status
        ;;
    "uninstall" )
        uninstall
        ;;
    * )
        usage
        ;;
esac