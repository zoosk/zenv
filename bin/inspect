#! /usr/bin/env bash

# Usage information
if [ "$1" == '-h' -o "$1" == '--help' ]; then
    PROGNAME=$(basename $0)
    echo "${PROGNAME}: Gather information about workspaces."
    echo "Usage (find initialized workspaces): ${PROGNAME}"
    echo "Usage (get information about a workspace): ${PROGNAME} workspace_name [key]"
    echo '    where key is one of repo_type, branch, dev_server, db_ip, server_dir, props_file, or build_cmd'
    exit 1
fi

if [ -z "$ZENV_INITIALIZED" ]; then
    echo 'This script must be run from within ZEnv.'
    exit 1
fi

if [ "$1" == '' ]; then
    find "$ZENV_WORKSPACE" -maxdepth 5 -name "$ZENV_WORKSPACE_SETTINGS" | xargs -n 1 dirname | xargs basename
elif [ ! -e "${ZENV_WORKSPACE}/$1" -a "$(echo "$1" | egrep '^/'; echo $?)" == '1' ]; then
    echoerr "$1: Workspace not found"
    exit 1
else
    if [ "$(echo "$1" | egrep '^/'; echo $?)" == '1' ]; then
        cd "${ZENV_WORKSPACE}/$1"
    else
        cd "$1"
    fi

    if [ -e .svn ]; then
        URL=$(svn info | egrep --only-matching 'URL: .*')
        REPO_KIND=$(echo "$URL" | sed 's|.*s\.zoosk\.com/\([^/]*\)/.*|\1|')
        BRANCH=$(echo "$URL" | egrep --only-matching 'URL: .*' | sed 's|.*/||')
    elif [ -e .git ]; then
        REPO_KIND=$(git remote -v | egrep -m 1 '\(fetch\)$' | sed -E 's|.*/([^/]+)(\.git)* .*\(fetch\)|\1|')
        BRANCH=$(git branch | egrep '^\*' | awk '{print $2}')
    else
        echoerr "There is no checkout in $PWD"
        exit 1
    fi

    case "$2" in
        'repo_type' )
            echo "$REPO_KIND"
            ;;
        'branch' )
            echo "$BRANCH"
            ;;
        'dev_server' )
            source "${ZENV_WORKSPACE_SETTINGS}"
            echo "$ZENV_DEVSERVER"
            ;;
        'db_ip' )
            source "${ZENV_WORKSPACE_SETTINGS}"
            echo "$ZENV_DBIP"
            ;;
        'server_dir' )
            source "${ZENV_WORKSPACE_SETTINGS}"
            echo "$ZENV_SERVERDIR"
            ;;
        'props_file' )
            source "${ZENV_WORKSPACE_SETTINGS}"
            echo "$ZENV_BUILDPROPS"
            ;;
        'build_cmd' )
            source "${ZENV_WORKSPACE_SETTINGS}"
            echo "$ZENV_BUILD_COMMAND"
            ;;
        * )
            source "${ZENV_WORKSPACE_SETTINGS}"
            echo "Workspace: ${PWD}
Repo type: ${REPO_KIND}
Branch: ${BRANCH}
Dev server: ${ZENV_DEVSERVER}
Database IP: ${ZENV_DBIP}
Local server directory: ${ZENV_SERVERDIR}
Properties file: ${ZENV_BUILDPROPS}
Build command: ${ZENV_BUILD_COMMAND}
"
            ;;
    esac
fi
